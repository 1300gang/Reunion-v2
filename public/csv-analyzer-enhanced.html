<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scenario Analytics - Modern CSV Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --border: #e2e8f0;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(251, 191, 36, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(129, 140, 248, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(76, 29, 149, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Header avec glassmorphisme */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        /* Boutons modernes */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Zone de d√©p√¥t moderne */
        .drop-zone {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 2px dashed var(--primary);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .drop-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drop-zone:hover::before,
        .drop-zone.dragover::before {
            opacity: 0.05;
        }

        .drop-zone.dragover {
            border-color: var(--secondary);
            transform: scale(1.02);
        }

        .drop-zone-content {
            position: relative;
            z-index: 1;
        }

        .drop-zone h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .drop-zone p {
            color: var(--gray);
            margin-bottom: 1rem;
        }

        /* Cartes de statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease;
            animation-fill-mode: both;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        .stat-card:nth-child(5) { animation-delay: 0.5s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-icon.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .stat-icon.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .stat-icon.warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .stat-icon.info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .stat-icon.danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .stat-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Section des graphiques */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--dark);
        }

        /* Filtres avanc√©s */
        .filters-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray);
        }

        .filter-input,
        .filter-select {
            padding: 0.625rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Cartes de donn√©es modernes */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .data-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .card-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-bottom: 1px solid var(--border);
        }

        .card-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray);
        }

        .card-body {
            padding: 1.5rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 0.875rem;
            color: var(--gray);
            font-weight: 500;
        }

        .info-value {
            font-size: 0.875rem;
            color: var(--dark);
            font-weight: 600;
        }

        /* Tags et badges */
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            color: var(--primary);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            gap: 0.25rem;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Table moderne */
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        }

        .data-table th {
            padding: 1rem;
            text-align: left;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
        }

        .data-table td {
            padding: 1rem;
            font-size: 0.875rem;
            color: var(--dark);
            border-bottom: 1px solid var(--border);
        }

        .data-table tbody tr {
            transition: all 0.3s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        /* Loading et √©tats vides */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        /* Animations suppl√©mentaires */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">üìä</div>
                    <span>Scenario Analytics</span>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="btn btn-secondary" onclick="toggleView()">
                        <span id="viewIcon">üìä</span>
                        <span id="viewText">Vue Tableau</span>
                    </button>
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        <span>üìÅ</span>
                        Charger CSV
                    </button>
                    <button class="btn btn-danger" onclick="clearAll()">
                        <span>üóëÔ∏è</span>
                        Effacer
                    </button>
                    <input type="file" id="fileInput" accept=".csv" multiple style="display: none;">
                </div>
            </div>
        </div>

        <!-- Zone de d√©p√¥t -->
        <div class="drop-zone" id="dropZone">
            <div class="drop-zone-content">
                <h3>üì§ Glissez vos fichiers CSV ici</h3>
                <p>ou cliquez pour s√©lectionner plusieurs fichiers</p>
                <button class="btn btn-primary">S√©lectionner les fichiers</button>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-icon primary">üìä</div>
                <div class="stat-value" id="totalEntries">0</div>
                <div class="stat-label">Entr√©es totales</div>
                <div class="stat-change positive">
                    <span>‚Üë</span>
                    <span id="entriesChange">+0%</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success">üë•</div>
                <div class="stat-value" id="totalParticipants">0</div>
                <div class="stat-label">Participants</div>
                <div class="stat-change positive">
                    <span>‚Üë</span>
                    <span id="participantsChange">+0%</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning">üé≠</div>
                <div class="stat-value" id="totalScenarios">0</div>
                <div class="stat-label">Sc√©narios</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon info">üìÅ</div>
                <div class="stat-value" id="totalFiles">0</div>
                <div class="stat-label">Fichiers</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon danger">üìà</div>
                <div class="stat-value" id="avgAge">0</div>
                <div class="stat-label">√Çge moyen</div>
            </div>
        </div>

        <!-- Section des graphiques -->
        <div class="charts-section" id="chartsSection" style="display: none;">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Distribution par Genre</h3>
                </div>
                <canvas id="genderChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">R√©partition par √Çge</h3>
                </div>
                <canvas id="ageChart"></canvas>
            </div>
        </div>

        <!-- Filtres -->
        <div class="filters-section" id="filtersSection" style="display: none;">
            <div class="filters-header">
                <h3>üîç Filtres avanc√©s</h3>
                <button class="btn btn-secondary" onclick="resetFilters()">R√©initialiser</button>
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Recherche</label>
                    <input type="text" class="filter-input" id="searchInput" placeholder="Rechercher...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Fichier</label>
                    <select class="filter-select" id="fileFilter">
                        <option value="">Tous les fichiers</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Sc√©nario</label>
                    <select class="filter-select" id="scenarioFilter">
                        <option value="">Tous les sc√©narios</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Genre</label>
                    <select class="filter-select" id="genderFilter">
                        <option value="">Tous les genres</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">√âcole</label>
                    <select class="filter-select" id="schoolFilter">
                        <option value="">Toutes les √©coles</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Tranche d'√¢ge</label>
                    <select class="filter-select" id="ageRangeFilter">
                        <option value="">Tous les √¢ges</option>
                        <option value="0-10">0-10 ans</option>
                        <option value="11-15">11-15 ans</option>
                        <option value="16-20">16-20 ans</option>
                        <option value="21-30">21-30 ans</option>
                        <option value="31+">31+ ans</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Grille de donn√©es -->
        <div id="dataContainer"></div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let loadedFiles = new Map();
        let currentView = 'cards';
        let charts = {};

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            setupEventListeners();
            
            // Essayer de charger le fichier par d√©faut
            try {
                const csvContent = await window.fs.readFile('results_St_r_otypes__discrim_egrtrttrrd_20250912_a9320aed48d722ce.csv', { encoding: 'utf8' });
                processCSV('results_St_r_otypes__discrim_egrtrttrrd_20250912_a9320aed48d722ce.csv', csvContent);
            } catch (error) {
                console.log('Fichier par d√©faut non trouv√©');
            }
        });

        // Configuration des √©v√©nements
        function setupEventListeners() {
            // Drag and drop
            const dropZone = document.getElementById('dropZone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
            });

            dropZone.addEventListener('drop', handleDrop, false);
            dropZone.addEventListener('click', () => document.getElementById('fileInput').click());

            // File input
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // Filtres
            ['searchInput', 'fileFilter', 'scenarioFilter', 'genderFilter', 'schoolFilter', 'ageRangeFilter'].forEach(id => {
                document.getElementById(id).addEventListener('input', applyFilters);
                document.getElementById(id).addEventListener('change', applyFilters);
            });
        }

        // Gestion des fichiers
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            processFiles(files);
        }

        function handleFileSelect(e) {
            processFiles(e.target.files);
        }

        function processFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    const reader = new FileReader();
                    reader.onload = (e) => processCSV(file.name, e.target.result);
                    reader.readAsText(file);
                }
            });
        }

        function processCSV(fileName, content) {
            Papa.parse(content, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => {
                    const cleanedData = results.data.filter(row => 
                        Object.values(row).some(value => value !== null && value !== '')
                    ).map(row => ({
                        ...row,
                        _sourceFile: fileName
                    }));

                    loadedFiles.set(fileName, {
                        name: fileName,
                        data: cleanedData,
                        timestamp: new Date()
                    });

                    combineData();
                    updateUI();
                }
            });
        }

        function combineData() {
            allData = [];
            loadedFiles.forEach(file => {
                allData = allData.concat(file.data);
            });
            filteredData = [...allData];
        }

        function updateUI() {
            if (allData.length === 0) {
                document.getElementById('dropZone').style.display = 'block';
                document.getElementById('statsGrid').style.display = 'none';
                document.getElementById('chartsSection').style.display = 'none';
                document.getElementById('filtersSection').style.display = 'none';
                return;
            }

            document.getElementById('dropZone').style.display = 'none';
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('chartsSection').style.display = 'grid';
            document.getElementById('filtersSection').style.display = 'block';

            updateStats();
            updateFilters();
            updateCharts();
            renderData();
        }

        function updateStats() {
            // Calcul des statistiques
            const totalEntries = filteredData.length;
            const participants = new Set(filteredData.map(row => row['Pr√©nom']).filter(Boolean));
            const scenarios = new Set(filteredData.map(row => row['Nom du sc√©nario']).filter(Boolean));
            const ages = filteredData.map(row => parseInt(row['√Çge'])).filter(age => !isNaN(age));
            const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : 0;

            // Mise √† jour des valeurs
            document.getElementById('totalEntries').textContent = totalEntries.toLocaleString();
            document.getElementById('totalParticipants').textContent = participants.size.toLocaleString();
            document.getElementById('totalScenarios').textContent = scenarios.size.toLocaleString();
            document.getElementById('totalFiles').textContent = loadedFiles.size.toLocaleString();
            document.getElementById('avgAge').textContent = avgAge;

            // Calcul des changements (simul√© pour la d√©mo)
            const entriesChange = Math.round(Math.random() * 20 + 5);
            const participantsChange = Math.round(Math.random() * 15 + 3);
            
            document.getElementById('entriesChange').textContent = `+${entriesChange}%`;
            document.getElementById('participantsChange').textContent = `+${participantsChange}%`;
        }

        function updateFilters() {
            // Fichiers
            const fileSelect = document.getElementById('fileFilter');
            const currentFile = fileSelect.value;
            fileSelect.innerHTML = '<option value="">Tous les fichiers</option>';
            loadedFiles.forEach((file, name) => {
                fileSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
            fileSelect.value = currentFile;

            // Sc√©narios
            const scenarios = [...new Set(allData.map(row => row['Nom du sc√©nario']).filter(Boolean))];
            updateSelectOptions('scenarioFilter', scenarios);

            // Genres
            const genders = [...new Set(allData.map(row => row['Genre']).filter(Boolean))];
            updateSelectOptions('genderFilter', genders);

            // √âcoles
            const schools = [...new Set(allData.map(row => row['√âcole']).filter(Boolean))];
            updateSelectOptions('schoolFilter', schools);
        }

        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            const defaultOption = select.querySelector('option').textContent;
            
            select.innerHTML = `<option value="">${defaultOption}</option>`;
            options.sort().forEach(option => {
                select.innerHTML += `<option value="${option}">${option}</option>`;
            });
            
            if (options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const fileFilter = document.getElementById('fileFilter').value;
            const scenarioFilter = document.getElementById('scenarioFilter').value;
            const genderFilter = document.getElementById('genderFilter').value;
            const schoolFilter = document.getElementById('schoolFilter').value;
            const ageRangeFilter = document.getElementById('ageRangeFilter').value;

            filteredData = allData.filter(row => {
                // Recherche textuelle
                const matchesSearch = !searchTerm || 
                    Object.values(row).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );

                // Filtres sp√©cifiques
                const matchesFile = !fileFilter || row._sourceFile === fileFilter;
                const matchesScenario = !scenarioFilter || row['Nom du sc√©nario'] === scenarioFilter;
                const matchesGender = !genderFilter || row['Genre'] === genderFilter;
                const matchesSchool = !schoolFilter || row['√âcole'] === schoolFilter;

                // Filtre d'√¢ge
                let matchesAge = true;
                if (ageRangeFilter) {
                    const age = parseInt(row['√Çge']);
                    if (!isNaN(age)) {
                        switch(ageRangeFilter) {
                            case '0-10': matchesAge = age >= 0 && age <= 10; break;
                            case '11-15': matchesAge = age >= 11 && age <= 15; break;
                            case '16-20': matchesAge = age >= 16 && age <= 20; break;
                            case '21-30': matchesAge = age >= 21 && age <= 30; break;
                            case '31+': matchesAge = age >= 31; break;
                        }
                    } else {
                        matchesAge = false;
                    }
                }

                return matchesSearch && matchesFile && matchesScenario && 
                       matchesGender && matchesSchool && matchesAge;
            });

            updateStats();
            updateCharts();
            renderData();
        }

        function updateCharts() {
            // Graphique des genres
            const genderCounts = {};
            filteredData.forEach(row => {
                const gender = row['Genre'] || 'Non sp√©cifi√©';
                genderCounts[gender] = (genderCounts[gender] || 0) + 1;
            });

            const genderCtx = document.getElementById('genderChart').getContext('2d');
            if (charts.gender) charts.gender.destroy();
            
            charts.gender = new Chart(genderCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(genderCounts),
                    datasets: [{
                        data: Object.values(genderCounts),
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(196, 181, 253, 0.8)'
                        ],
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });

            // Graphique des √¢ges
            const ageRanges = { '0-10': 0, '11-15': 0, '16-20': 0, '21-30': 0, '31+': 0 };
            filteredData.forEach(row => {
                const age = parseInt(row['√Çge']);
                if (!isNaN(age)) {
                    if (age <= 10) ageRanges['0-10']++;
                    else if (age <= 15) ageRanges['11-15']++;
                    else if (age <= 20) ageRanges['16-20']++;
                    else if (age <= 30) ageRanges['21-30']++;
                    else ageRanges['31+']++;
                }
            });

            const ageCtx = document.getElementById('ageChart').getContext('2d');
            if (charts.age) charts.age.destroy();
            
            charts.age = new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ageRanges),
                    datasets: [{
                        label: 'Nombre de participants',
                        data: Object.values(ageRanges),
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function renderData() {
            const container = document.getElementById('dataContainer');
            
            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <h3>Aucune donn√©e trouv√©e</h3>
                        <p>Modifiez vos filtres ou chargez de nouveaux fichiers</p>
                    </div>
                `;
                return;
            }

            if (currentView === 'cards') {
                renderCardsView(container);
            } else {
                renderTableView(container);
            }
        }

        function renderCardsView(container) {
            const html = filteredData.map((row, index) => {
                const firstName = row['Pr√©nom'] || 'Anonyme';
                const age = row['√Çge'] || '?';
                const gender = row['Genre'] || 'Non sp√©cifi√©';
                const school = row['√âcole'] || 'Non sp√©cifi√©e';
                const scenario = row['Nom du sc√©nario'] || 'Sc√©nario inconnu';
                const avatar = firstName.charAt(0).toUpperCase();

                // Extraire les sc√®nes
                const scenes = Object.keys(row)
                    .filter(key => key.startsWith('scene') && !key.includes('theme'))
                    .map(key => ({
                        name: key,
                        value: row[key],
                        themes: row[`theme_aborde_${key}`]
                    }))
                    .filter(scene => scene.value);

                return `
                    <div class="data-card" style="animation-delay: ${index * 0.05}s">
                        <div class="card-header">
                            <div class="card-avatar">${avatar}</div>
                            <div>
                                <h3 class="card-title">${firstName}</h3>
                                <div class="card-subtitle">
                                    <span class="badge badge-success">${age} ans</span>
                                    <span class="badge badge-warning">${gender}</span>
                                    <span class="tag">${school}</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="info-row">
                                <span class="info-label">Sc√©nario</span>
                                <span class="info-value">${scenario}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Fichier source</span>
                                <span class="info-value" style="font-size: 0.75rem;">${row._sourceFile}</span>
                            </div>
                            ${scenes.length > 0 ? `
                                <div class="info-row">
                                    <span class="info-label">Sc√®nes (${scenes.length})</span>
                                </div>
                                ${scenes.map(scene => `
                                    <div style="margin-top: 0.5rem; padding: 0.75rem; background: rgba(99, 102, 241, 0.05); border-radius: 8px;">
                                        <strong style="color: var(--primary);">${scene.name}</strong>
                                        <div style="margin-top: 0.25rem;">${scene.value}</div>
                                        ${scene.themes ? `
                                            <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                                ${scene.themes.split(';').map(theme => 
                                                    `<span class="tag">${theme.trim()}</span>`
                                                ).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="data-grid">${html}</div>`;
        }

        function renderTableView(container) {
            const headers = Object.keys(filteredData[0] || {}).filter(h => h !== '_sourceFile');
            
            const html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fichier</th>
                                ${headers.map(h => `<th>${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredData.map(row => `
                                <tr>
                                    <td><span class="tag">${row._sourceFile}</span></td>
                                    ${headers.map(h => {
                                        const value = row[h] || '';
                                        if (typeof value === 'string' && value.includes(';')) {
                                            return `<td>${value.split(';').map(v => 
                                                `<span class="tag">${v.trim()}</span>`
                                            ).join(' ')}</td>`;
                                        }
                                        return `<td>${value}</td>`;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function toggleView() {
            currentView = currentView === 'cards' ? 'table' : 'cards';
            document.getElementById('viewIcon').textContent = currentView === 'cards' ? 'üìä' : 'üìá';
            document.getElementById('viewText').textContent = currentView === 'cards' ? 'Vue Tableau' : 'Vue Cartes';
            renderData();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('fileFilter').value = '';
            document.getElementById('scenarioFilter').value = '';
            document.getElementById('genderFilter').value = '';
            document.getElementById('schoolFilter').value = '';
            document.getElementById('ageRangeFilter').value = '';
            
            filteredData = [...allData];
            updateStats();
            updateCharts();
            renderData();
        }

        function clearAll() {
            if (!confirm('√ätes-vous s√ªr de vouloir effacer toutes les donn√©es ?')) return;
            
            allData = [];
            filteredData = [];
            loadedFiles.clear();
            
            // D√©truire les graphiques
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            updateUI();
        }
    </script>
</body>
</html>